import json
import csv
# from similar_text import similar_text

TSV_ORIGINAL = "dev_inputs.tsv"
JSON1 = "output_results.json"
OUTPUT = "output.tsv"

def detoxify_message(msg: str) -> str:
    if not msg.strip():  # если сообщение пустое — вернуть как есть
        return msg
    msg = msg.replace("```json", "").replace("```", "")
    return msg


with open(JSON1, "r", encoding="utf-8") as file:
    data = json.load(file)

msg = detoxify_message(" ".join(data[3]["0"][1:]))

modified_rows = []
for i in range(len(data)):
    msg = detoxify_message(" ".join(data[i]["0"][1:]))
    result = json.loads(msg)
    for elem in result:
        elem["detoxified_text"] = elem["detoxified_text"].replace("**", "").replace("\\", "").replace("\"", "")
        modified_rows.append([elem["string_number"], elem["detoxified_text"]])





new_rows = []
with open(TSV_ORIGINAL, encoding="utf-8-sig") as fd:
    rd = csv.reader(fd, delimiter="\t")
    header = next(rd)  # читаем заголовок
    print(header)
    # Ожидаем: ['ID', 'tat_toxic']
    # assert len(header) == 2 and header[0] == "ID" and header[1] == "tat_toxic", \
        # "Unexpected header in input TSV"

    # Добавляем третий столбец
    new_header = ["ID", "tat_toxic", "tat_detox1"]
    new_rows.append(new_header)
    for row in rd:
        new_rows.append(row)

    line_count = -1
    for i in modified_rows:
        new_rows[int(i[0]) + 1].append(i[1])

# Запись результат
with open(OUTPUT, "w", encoding="utf-8", newline='') as f:
    writer = csv.writer(f, delimiter="\t", quoting=csv.QUOTE_NONE, escapechar='\\')
    writer.writerows(new_rows)
print(f"✅ {len(new_rows) - 1} rows processed. Saved to {OUTPUT}")
